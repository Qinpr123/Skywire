<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’¢ä¸è¡Œè€… - å¹³è¡¡æŒ‘æˆ˜</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="bgBlur"></div>
    <div id="gameContainer" data-design-width="832" data-design-height="1480">
        <canvas id="gameCanvas" width="832" height="1480"></canvas>
        <div id="gameUI">
            <div>è·ç¦»: <span id="distance">0</span>m</div>
            <div>æ‘†å¹…: <span id="sway">0</span>Â°</div>
            <div>é£åŠ›: <span id="wind">0</span></div>
            <div>æœ€é«˜åˆ†: <span id="highScore">0</span>m</div>
            <div id="audioControls">
                <button id="muteBtn" title="é™éŸ³/å–æ¶ˆé™éŸ³">ğŸ”Š</button>
                <input type="range" id="volumeSlider" min="0" max="100" value="30" title="éŸ³é‡æ§åˆ¶">
            </div>
        </div>
        <div id="instructions">
            <div>â† â†’ æ§åˆ¶å¹³è¡¡</div>
            <div>Z ä¼¸é•¿å¹³è¡¡æ†</div>
            <div>X ç¼©çŸ­å¹³è¡¡æ†</div>
            <div>ä¿æŒæ‘†å¹… < 60Â°</div>
            <div>æŒ‰ç©ºæ ¼é”®å¼€å§‹</div>
        </div>
        
        <div id="powerUpLegend">
            <div style="color: #000000; font-weight: bold;">âš« é»‘è‰²æ°”çƒ - çˆ†ç‚¸</div>
            <div style="color: #FF0000; font-weight: bold;">ğŸ”´ çº¢è‰²æ°”çƒ - åŠ é€Ÿ</div>
            <div style="color: #00FF00; font-weight: bold;">ğŸŸ¢ ç»¿è‰²æ°”çƒ - å¹³è¡¡</div>
            <div style="color: #0080FF; font-weight: bold;">ğŸ”µ è“è‰²æ°”çƒ - å‡é€Ÿ</div>
            <div style="color: #FFFF00; font-weight: bold;">ğŸŸ¡ é»„è‰²æ°”çƒ - å¤±è¡¡</div>
        </div>
        <div id="startScreen">
            <h1>é’¢ä¸è¡Œè€…</h1>
            <p>ä¿æŒå¹³è¡¡ï¼Œèµ°å¾—æ›´è¿œï¼</p>
            <p>ä½¿ç”¨ â† â†’ é”®æ§åˆ¶å¹³è¡¡</p>
            <p>æŒ‰ç©ºæ ¼é”®å¼€å§‹æ¸¸æˆ</p>
        </div>
        <div id="gameOver">
            <h2>æ¸¸æˆç»“æŸï¼</h2>
            <p>ä½ èµ°äº† <span id="finalDistance">0</span> ç±³</p>
            <button id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script src="main.js"></script>
    <script>
        class TightropeGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = this.canvas.width;
                this.height = this.canvas.height;
                
                // æ¸¸æˆçŠ¶æ€
                this.gameRunning = false;
                this.distance = 0;
                this.speed = 0.083; // 1ç§’5ç±³ï¼Œ60fpsä¸‹æ¯å¸§çº¦0.083ç±³
                this.score = 0;
                this.highScore = localStorage.getItem('tightropeHighScore') || 0;
                this.gameStarted = false;
                
                // ä¸»è§’å±æ€§
                this.player = {
                    x: this.width / 2,
                    y: this.height / 2,
                    sway: 0, // æ‘†å¹…è§’åº¦
                    swaySpeed: 0, // æ‘†å¹…é€Ÿåº¦
                    size: 40
                };
                
                // é’¢ä¸
                this.tightrope = {
                    x: this.width / 2,
                    thickness: 6
                };
                
                // é£åŠ›ç³»ç»Ÿ
                this.wind = {
                    force: 0,
                    direction: 1, // 1 æˆ– -1
                    changeTimer: 0,
                    changeInterval: 60 // å¸§æ•°
                };
                
                // èƒŒæ™¯
                this.background = {
                    offset: 0,
                    speed: 1
                };
                
                // ç²’å­ç³»ç»Ÿ
                this.particles = [];
                
                // ç”°å›­é£æ™¯ç³»ç»Ÿ
                this.landscape = [];
                this.landscapeSpeed = this.speed * 2; // èƒŒæ™¯æ»šåŠ¨é€Ÿåº¦æå‡ä¸¤å€
                this.landscapeSpawnTimer = 0;
                this.landscapeSpawnInterval = 200; // å¸§æ•°ï¼Œé™ä½ç”Ÿæˆé¢‘ç‡
                
                // äº‘æœµç³»ç»Ÿ
                this.clouds = [];
                this.cloudSpawnTimer = 0;
                this.cloudSpawnInterval = 200; // å¸§æ•°
                
                // é“å…·ç³»ç»Ÿ
                this.powerUps = [];
                this.powerUpSpawnTimer = 0;
                this.powerUpSpawnInterval = 20; // å¸§æ•°ï¼Œ0.3ç§’ç”Ÿæˆä¸€ä¸ª
                this.activePowerUps = []; // å½“å‰æ¿€æ´»çš„é“å…·
                
                // å¹³è¡¡æ†ç³»ç»Ÿ
                this.balanceRod = {
                    length: 60, // é»˜è®¤é•¿åº¦
                    minLength: 30,
                    maxLength: 120,
                    extendSpeed: 2
                };
                
                // æ§åˆ¶
                this.keys = {};
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.gameLoop();
            }
            
            setupEventListeners() {
                // é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    if (e.code === 'Space' && !this.gameRunning) {
                        this.startGame();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
                
                // é‡æ–°å¼€å§‹æŒ‰é’®
                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.restartGame();
                });
            }
            
            startGame() {
                this.gameRunning = true;
                this.gameStarted = true;
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('gameOver').style.display = 'none';
                this.resetGame();
                this.initializeLandscape(); // åˆå§‹åŒ–ç”°å›­é£æ™¯
                this.initializeClouds(); // åˆå§‹åŒ–äº‘æœµ
            }
            
            restartGame() {
                this.gameRunning = true;
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('gameOver').style.display = 'none';
                this.resetGame();
                this.initializeLandscape(); // åˆå§‹åŒ–ç”°å›­é£æ™¯
                this.initializeClouds(); // åˆå§‹åŒ–äº‘æœµ
            }
            
            resetGame() {
                this.distance = 0;
                this.score = 0;
                this.player.x = this.width / 2;
                this.player.y = this.height / 2;
                this.player.sway = 0;
                this.player.swaySpeed = 0;
                this.wind.force = 0;
                this.wind.direction = 1;
                this.wind.changeTimer = 0;
                this.background.offset = 0;
                this.landscape = [];
                this.landscapeSpawnTimer = 0;
                this.clouds = [];
                this.cloudSpawnTimer = 0;
                this.powerUps = [];
                this.powerUpSpawnTimer = 0;
                this.activePowerUps = [];
                this.balanceRod.length = 60;
            }
            
            update() {
                if (!this.gameRunning) return;
                
                // æ›´æ–°è·ç¦»å’Œåˆ†æ•°
                this.distance += this.speed;
                this.score = Math.floor(this.distance);
                
                // æ›´æ–°é£åŠ›
                this.updateWind();
                
                // æ›´æ–°ç©å®¶å¹³è¡¡
                this.updatePlayerBalance();
                
                // æ›´æ–°èƒŒæ™¯
                this.updateBackground();
                
                // æ›´æ–°ç²’å­
                this.updateParticles();
                
                // æ›´æ–°ç”°å›­é£æ™¯
                this.updateLandscape();
                
                // æ›´æ–°äº‘æœµ
                this.updateClouds();
                
                // æ›´æ–°é“å…·
                this.updatePowerUps();
                
                // æ›´æ–°å¹³è¡¡æ†
                this.updateBalanceRod();
                
                // æ£€æŸ¥å¤±è´¥æ¡ä»¶
                this.checkGameOver();
                
                // æ›´æ–°UI
                this.updateUI();
            }
            
            updateWind() {
                this.wind.changeTimer++;
                if (this.wind.changeTimer >= this.wind.changeInterval) {
                    this.wind.direction *= -1;
                    this.wind.force = (Math.random() - 0.5) * 0.3;
                    this.wind.changeTimer = 0;
                    this.wind.changeInterval = 30 + Math.random() * 60;
                }
                
                // é£åŠ›é€æ¸å˜åŒ–
                this.wind.force += (Math.random() - 0.5) * 0.02;
                this.wind.force = Math.max(-0.5, Math.min(0.5, this.wind.force));
            }
            
            updatePlayerBalance() {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¹³è¡¡å¢å¼ºé“å…·ä¸”å…ç–«é”®ç›˜è¾“å…¥
                let isImmuneToInput = false;
                let isBalanceRestore = false;
                for (let powerUp of this.activePowerUps) {
                    if (powerUp.type === 'balance' && powerUp.immuneToInput) {
                        isImmuneToInput = true;
                        if (powerUp.balanceRestore) {
                            isBalanceRestore = true;
                        }
                        break;
                    }
                }
                
                // å¦‚æœå¤„äºå¹³è¡¡æ¢å¤çŠ¶æ€ï¼Œä¿æŒå¹³è¡¡
                if (isBalanceRestore) {
                    this.player.sway = 0; // å¼ºåˆ¶ä¿æŒå¹³è¡¡
                    this.player.swaySpeed = 0; // åœæ­¢æ‘†è¡
                    return; // ç›´æ¥è¿”å›ï¼Œä¸å¤„ç†å…¶ä»–åŠ›
                }
                
                // é£åŠ›å½±å“ï¼ˆç¼©å°ä¸¤å€ï¼‰
                let windEffect = this.wind.force * this.wind.direction * 0.5; // ä»1ç¼©å°åˆ°0.5
                
                // ç©å®¶æ§åˆ¶ï¼ˆç¼©å°ä¸¤å€ï¼Œä¸”å¯èƒ½è¢«å…ç–«ï¼‰
                let controlForce = 0;
                if (!isImmuneToInput) { // åªæœ‰åœ¨ä¸å…ç–«é”®ç›˜è¾“å…¥æ—¶æ‰å“åº”
                    if (this.keys['ArrowLeft']) {
                        controlForce = -0.075; // ä»-0.15ç¼©å°åˆ°-0.075
                    }
                    if (this.keys['ArrowRight']) {
                        controlForce = 0.075; // ä»0.15ç¼©å°åˆ°0.075
                    }
                }
                
                // è®¡ç®—æ€»åŠ›
                let totalForce = windEffect + controlForce;
                
                // æ›´æ–°æ‘†å¹…é€Ÿåº¦
                this.player.swaySpeed += totalForce;
                
                // åº”ç”¨å¹³è¡¡é“å…·æ•ˆæœ
                let damping = 0.95; // é»˜è®¤é˜»å°¼
                for (let powerUp of this.activePowerUps) {
                    if (powerUp.type === 'balance') {
                        damping = 0.98; // å¢å¼ºé˜»å°¼ï¼Œå‡å°‘æ‘†è¡
                    } else if (powerUp.type === 'unbalance') {
                        damping = 0.90; // å‡å°‘é˜»å°¼ï¼Œå¢åŠ æ‘†è¡
                    }
                }
                this.player.swaySpeed *= damping;
                
                // æ›´æ–°æ‘†å¹…
                this.player.sway += this.player.swaySpeed;
                
                // é™åˆ¶æ‘†å¹…èŒƒå›´
                this.player.sway = Math.max(-90, Math.min(90, this.player.sway));
                
                // æ›´æ–°ç©å®¶ä½ç½®ï¼ˆä»¥è„šä¸ºåœ†å¿ƒæ—‹è½¬ï¼‰
                this.player.x = this.tightrope.x;
                this.player.y = this.height / 2;
            }
            
            updateBackground() {
                this.background.offset += this.background.speed;
                if (this.background.offset >= this.height) {
                    this.background.offset = 0;
                }
            }
            
            updateParticles() {
                // æ·»åŠ æ–°ç²’å­
                if (Math.random() < 0.3) {
                    this.particles.push({
                        x: Math.random() * this.width,
                        y: this.height + 10,
                        vx: (Math.random() - 0.5) * 2,
                        vy: -Math.random() * 3 - 1,
                        life: 1.0,
                        decay: 0.01,
                        size: Math.random() * 3 + 1
                    });
                }
                
                // æ›´æ–°ç°æœ‰ç²’å­
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.life -= particle.decay;
                    
                    if (particle.life <= 0 || particle.y < -10) {
                        this.particles.splice(i, 1);
                    }
                }
            }
            
            updateLandscape() {
                // åŒæ­¥é£æ™¯æ»šåŠ¨é€Ÿåº¦ä¸äººç‰©é€Ÿåº¦
                let baseSpeed = this.speed * 10; // èƒŒæ™¯ç§»åŠ¨é€Ÿåº¦ä¸ºäººç‰©é€Ÿåº¦çš„5å€
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€Ÿåº¦æå‡é“å…·ï¼Œå¦‚æœæœ‰åˆ™å†å¢åŠ 2å€
                for (let powerUp of this.activePowerUps) {
                    if (powerUp.type === 'speed') {
                        baseSpeed *= 3; // åŠ é€Ÿæ—¶èƒŒæ™¯å»ºç­‘ç§»é€Ÿå¢åŠ 2å€
                        break;
                    }
                }
                
                this.landscapeSpeed = baseSpeed;
                
                // ç”Ÿæˆæ–°é£æ™¯å…ƒç´ 
                this.landscapeSpawnTimer++;
                if (this.landscapeSpawnTimer >= this.landscapeSpawnInterval) {
                    this.spawnLandscapeElement();
                    this.landscapeSpawnTimer = 0;
                    this.landscapeSpawnInterval = 30 + Math.random() * 50; // æ›´é¢‘ç¹ç”Ÿæˆï¼Œç¡®ä¿è¿ç»­å›¾æ¡ˆ
                }
                
                // æ›´æ–°ç°æœ‰é£æ™¯å…ƒç´ ä½ç½®
                for (let i = this.landscape.length - 1; i >= 0; i--) {
                    const element = this.landscape[i];
                    element.y += this.landscapeSpeed;
                    
                    // ç§»é™¤è¶…å‡ºå±å¹•çš„å…ƒç´ 
                    if (element.y > this.height + 100) {
                        this.landscape.splice(i, 1);
                    }
                }
            }
            
            updateClouds() {
                // ç”Ÿæˆæ–°äº‘æœµ
                this.cloudSpawnTimer++;
                if (this.cloudSpawnTimer >= this.cloudSpawnInterval) {
                    this.spawnCloud();
                    this.cloudSpawnTimer = 0;
                    this.cloudSpawnInterval = 150 + Math.random() * 200; // éšæœºé—´éš”
                }
                
                // æ›´æ–°ç°æœ‰äº‘æœµä½ç½®ï¼ˆæ ¹æ®é£åŠ›ï¼‰
                for (let i = this.clouds.length - 1; i >= 0; i--) {
                    const cloud = this.clouds[i];
                    
                    // äº‘æœµæ ¹æ®é£åŠ›ç§»åŠ¨
                    const windEffect = this.wind.force * this.wind.direction * 0.5; // é£åŠ›å½±å“ç³»æ•°
                    cloud.x += windEffect;
                    
                    // ç§»é™¤è¶…å‡ºå±å¹•çš„äº‘æœµ
                    if (cloud.x < -100 || cloud.x > this.width + 100) {
                        this.clouds.splice(i, 1);
                    }
                }
            }
            
            updatePowerUps() {
                // ç”Ÿæˆæ–°é“å…·
                this.powerUpSpawnTimer++;
                if (this.powerUpSpawnTimer >= this.powerUpSpawnInterval) {
                    this.spawnPowerUp();
                    this.powerUpSpawnTimer = 0;
                    this.powerUpSpawnInterval = 60 + Math.random() * 60; // 1-2ç§’éšæœºé—´éš”
                }
                
                // æ›´æ–°ç°æœ‰é“å…·ä½ç½®
                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];
                    powerUp.y += 7; // ä¸‹è½é€Ÿåº¦å‡ç¼“åˆ°1/3
                    
                    // æ£€æŸ¥æ˜¯å¦è¢«ç©å®¶æ”¶é›†
                    if (this.checkPowerUpCollision(powerUp)) {
                        this.collectPowerUp(powerUp);
                        this.powerUps.splice(i, 1);
                    }
                    // ç§»é™¤è¶…å‡ºå±å¹•çš„é“å…·
                    else if (powerUp.y > this.height + 100) {
                        this.powerUps.splice(i, 1);
                    }
                }
                
                // æ›´æ–°æ¿€æ´»çš„é“å…·
                for (let i = this.activePowerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.activePowerUps[i];
                    powerUp.duration--;
                    
                    if (powerUp.duration <= 0) {
                        this.deactivatePowerUp(powerUp);
                        this.activePowerUps.splice(i, 1);
                    }
                }
            }
            
            updateBalanceRod() {
                // å¹³è¡¡æ†ä¼¸é•¿ç¼©çŸ­æ§åˆ¶
                if (this.keys['KeyZ'] || this.keys['KeyX']) {
                    if (this.keys['KeyZ']) {
                        // Zé”®ä¼¸é•¿
                        this.balanceRod.length = Math.min(this.balanceRod.maxLength, 
                            this.balanceRod.length + this.balanceRod.extendSpeed);
                    }
                    if (this.keys['KeyX']) {
                        // Xé”®ç¼©çŸ­
                        this.balanceRod.length = Math.max(this.balanceRod.minLength, 
                            this.balanceRod.length - this.balanceRod.extendSpeed);
                    }
                }
            }
            
            spawnLandscapeElement() {
                const elementTypes = ['tree', 'farmhouse']; // åªä¿ç•™æ ‘æœ¨å’Œæˆ¿å±‹
                const elementType = elementTypes[Math.floor(Math.random() * elementTypes.length)];
                const rowY = -200; // ä»æ›´ä¸Šæ–¹å¼€å§‹
                
                // éšæœºé€‰æ‹©å·¦ä¾§æˆ–å³ä¾§ï¼Œä½†è¿œç¦»é’¢ä¸
                const side = Math.random() < 0.5 ? 'left' : 'right';
                let x;
                
                if (side === 'left') {
                    // å·¦ä¾§è¾¹æ²¿ï¼Œè¿œç¦»é’¢ä¸ï¼Œé¿å…é‡å 
                    x = 20 + Math.random() * 60; // ç¼©å°èŒƒå›´é¿å…é‡å 
                } else {
                    // å³ä¾§è¾¹æ²¿ï¼Œè¿œç¦»é’¢ä¸ï¼Œé¿å…é‡å 
                    x = this.width - 80 - Math.random() * 60; // ç¼©å°èŒƒå›´é¿å…é‡å 
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰å…ƒç´ é‡å 
                const minDistance = 70; // å‡å°‘æœ€å°è·ç¦»ï¼Œè®©å»ºç­‘æ›´å¯†é›†
                let canPlace = true;
                
                for (let existing of this.landscape) {
                    if (existing.side === side) {
                        const distance = Math.abs(existing.x - x);
                        if (distance < minDistance) {
                            canPlace = false;
                            break;
                        }
                    }
                }
                
                // åªæœ‰ä¸é‡å æ—¶æ‰æ·»åŠ 
                if (canPlace) {
                    this.landscape.push({
                        x: x,
                        y: rowY,
                        type: elementType,
                        side: side,
                        size: 60 + Math.random() * 120 // æ”¾å¤§3å€
                    });
                }
            }
            
            spawnCloud() {
                // æ ¹æ®é£å‘å†³å®šäº‘æœµç”Ÿæˆä½ç½®
                const windDirection = this.wind.direction;
                let startX;
                
                if (windDirection > 0) {
                    // é£å‘å³å¹ï¼Œäº‘æœµä»å·¦ä¾§è¿›å…¥
                    startX = -100;
                } else {
                    // é£å‘å·¦å¹ï¼Œäº‘æœµä»å³ä¾§è¿›å…¥
                    startX = this.width + 100;
                }
                
                this.clouds.push({
                    x: startX,
                    y: 30 + Math.random() * 100, // äº‘æœµé«˜åº¦éšæœº
                    size: 15 + Math.random() * 20, // äº‘æœµå¤§å°éšæœº
                    opacity: 0.6 + Math.random() * 0.4 // é€æ˜åº¦éšæœº
                });
            }
            
            spawnPowerUp() {
                // å‡å°‘çˆ†ç‚¸å‡ºç°é¢‘ç‡ï¼Œå…¶ä»–é“å…·å‡ºç°æ¦‚ç‡æ›´é«˜
                const types = ['speed', 'balance', 'slow', 'unbalance', 'speed', 'balance', 'slow', 'unbalance', 'explosion']; // çˆ†ç‚¸åªæœ‰1/9çš„æ¦‚ç‡
                const type = types[Math.floor(Math.random() * types.length)];
                
                // é“å…·æ‰è½èŒƒå›´ï¼šä»å¹³è¡¡æ†åˆå§‹é•¿åº¦åˆ°å¹³è¡¡æ†æœ€é•¿ä¼¸é•¿é•¿åº¦
                const tightropeX = this.tightrope.x;
                const minDistance = this.balanceRod.minLength+10; // å¹³è¡¡æ†åˆå§‹é•¿åº¦
                const maxDistance = this.balanceRod.maxLength; // å¹³è¡¡æ†æœ€é•¿ä¼¸é•¿é•¿åº¦
                
                // éšæœºé€‰æ‹©å·¦ä¾§æˆ–å³ä¾§
                const side = Math.random() < 0.5 ? -1 : 1;
                const distance = minDistance + Math.random() * (maxDistance - minDistance);
                const x = tightropeX + (side * distance);
                
                this.powerUps.push({
                    x: x,
                    y: -50, // ä»å±å¹•ä¸Šæ–¹å¼€å§‹
                    type: type,
                    size: 20,
                    collected: false
                });
            }
            
            checkPowerUpCollision(powerUp) {
                // æ£€æŸ¥é“å…·æ˜¯å¦ä¸å¹³è¡¡æ†ç¢°æ’
                const playerX = this.tightrope.x;
                const playerY = this.height / 2;
                const rodLength = this.balanceRod.length;
                
                // å¹³è¡¡æ†çš„å·¦å³ç«¯ç‚¹
                const rodLeft = playerX - rodLength;
                const rodRight = playerX + rodLength;
                
                // æ£€æŸ¥é“å…·æ˜¯å¦åœ¨å¹³è¡¡æ†èŒƒå›´å†…
                return powerUp.x >= rodLeft && powerUp.x <= rodRight && 
                       powerUp.y >= playerY - 20 && powerUp.y <= playerY + 20;
            }
            
            collectPowerUp(powerUp) {
                // æ’­æ”¾éŸ³æ•ˆ
                this.playSound(powerUp.type);
                
                // æ˜¾ç¤ºé“å…·æ•ˆæœ
                this.showPowerUpEffect(powerUp);
                
                // æ£€æŸ¥å¹³è¡¡é“å…·æ˜¯å¦ä¼šè¢«å…¶ä»–é“å…·å½±å“
                if (this.hasActivePowerUp('balance') && (powerUp.type === 'unbalance' || powerUp.type === 'slow')) {
                    // å¹³è¡¡é“å…·é‡åˆ°å¤±è¡¡æˆ–å‡é€Ÿé“å…·æ—¶ç«‹å³å¤±æ•ˆ
                    this.clearBalanceEffect();
                }
                
                // æ¿€æ´»æ–°é“å…·æ•ˆæœ
                const activePowerUp = {
                    type: powerUp.type,
                    duration: powerUp.type === 'balance' ? 180 : 300, // å¹³è¡¡3ç§’ï¼Œå…¶ä»–5ç§’ï¼Œ60fps
                    originalValue: null
                };
                
                if (powerUp.type === 'explosion') {
                    // çˆ†ç‚¸é“å…· - ç›´æ¥æ­»äº¡
                    this.gameOver();
                    return;
                } else if (powerUp.type === 'speed') {
                    // åŠ é€Ÿé“å…· - å¯ä»¥å åŠ 
                    if (this.hasActivePowerUp('speed')) {
                        // å¦‚æœå·²æœ‰åŠ é€Ÿæ•ˆæœï¼Œå åŠ æ•ˆæœ
                        this.speed *= 2; // å†æ¬¡æå‡2å€
                    } else {
                        // é¦–æ¬¡è·å¾—åŠ é€Ÿæ•ˆæœ
                        activePowerUp.originalValue = this.speed;
                        this.speed *= 2; // é€Ÿåº¦æå‡2å€
                    }
                } else if (powerUp.type === 'balance') {
                    // å¹³è¡¡å¢å¼ºé“å…· - å¯ä»¥å åŠ 
                    this.player.sway = 0; // ç«‹å³å›åˆ°ä¸­å¿ƒä½ç½®
                    this.player.swaySpeed = 0; // åœæ­¢æ‘†è¡
                    if (!this.hasActivePowerUp('balance')) {
                        // é¦–æ¬¡è·å¾—å¹³è¡¡æ•ˆæœ
                        activePowerUp.originalValue = 0.95; // é˜»å°¼ç³»æ•°
                        activePowerUp.immuneToInput = true; // æ ‡è®°ä¸ºå…ç–«é”®ç›˜è¾“å…¥
                        activePowerUp.balanceRestore = true; // æ ‡è®°ä¸ºå¹³è¡¡æ¢å¤çŠ¶æ€
                    } else {
                        // å åŠ å¹³è¡¡æ•ˆæœï¼Œå»¶é•¿æŒç»­æ—¶é—´
                        const existingBalance = this.activePowerUps.find(p => p.type === 'balance');
                        existingBalance.duration = 180; // é‡ç½®æŒç»­æ—¶é—´ä¸º3ç§’
                    }
                } else if (powerUp.type === 'slow') {
                    // å‡é€Ÿé“å…· - å¯ä»¥å åŠ 
                    if (this.hasActivePowerUp('slow')) {
                        // å¦‚æœå·²æœ‰å‡é€Ÿæ•ˆæœï¼Œå åŠ æ•ˆæœ
                        this.speed *= 0.5; // å†æ¬¡é™¤ä»¥2
                    } else {
                        // é¦–æ¬¡è·å¾—å‡é€Ÿæ•ˆæœ
                        activePowerUp.originalValue = this.speed;
                        this.speed *= 0.5; // é€Ÿåº¦é™¤ä»¥2
                    }
                } else if (powerUp.type === 'unbalance') {
                    // ç ´åå¹³è¡¡é“å…· - å¤±è¡¡æ•ˆæœï¼Œå‘æ°”çƒä¸‹è½æ–¹å‘æ—‹è½¬15åº¦
                    const unbalanceOffset = powerUp.x > this.tightrope.x ? 15 : -15; // æ ¹æ®æ°”çƒä½ç½®å†³å®šæ—‹è½¬æ–¹å‘
                    this.player.sway += unbalanceOffset; // å‘æ°”çƒä¸‹è½æ–¹å‘æ—‹è½¬15åº¦
                    // å¤±è¡¡é“å…·ä¹Ÿå¯ä»¥å åŠ ï¼Œå»¶é•¿æŒç»­æ—¶é—´
                    if (this.hasActivePowerUp('unbalance')) {
                        const existingUnbalance = this.activePowerUps.find(p => p.type === 'unbalance');
                        existingUnbalance.duration = 300; // é‡ç½®æŒç»­æ—¶é—´ä¸º5ç§’
                        return; // ä¸åˆ›å»ºæ–°çš„activePowerUp
                    }
                }
                
                // åªæœ‰é¦–æ¬¡è·å¾—çš„é“å…·æ‰æ·»åŠ åˆ°activePowerUps
                if (!this.hasActivePowerUp(powerUp.type)) {
                    this.activePowerUps.push(activePowerUp);
                }
            }
            
            hasActivePowerUp(type) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šç±»å‹çš„æ¿€æ´»é“å…·
                return this.activePowerUps.some(powerUp => powerUp.type === type);
            }
            
            clearBalanceEffect() {
                // æ¸…é™¤å¹³è¡¡é“å…·æ•ˆæœ
                const balanceIndex = this.activePowerUps.findIndex(powerUp => powerUp.type === 'balance');
                if (balanceIndex !== -1) {
                    this.activePowerUps.splice(balanceIndex, 1);
                }
                // æ¢å¤åŸå§‹é˜»å°¼ç³»æ•°
                this.player.damping = 0.95;
            }
            
            clearAllPowerUpEffects() {
                // æ¸…é™¤æ‰€æœ‰ç°æœ‰é“å…·æ•ˆæœï¼Œæ¢å¤åŸå§‹çŠ¶æ€
                for (let powerUp of this.activePowerUps) {
                    if (powerUp.type === 'speed' || powerUp.type === 'slow') {
                        this.speed = powerUp.originalValue;
                    }
                    // å…¶ä»–æ•ˆæœä¼šè‡ªåŠ¨æ¢å¤
                }
                this.activePowerUps = []; // æ¸…ç©ºæ‰€æœ‰æ¿€æ´»çš„é“å…·
            }
            
            deactivatePowerUp(powerUp) {
                // å–æ¶ˆé“å…·æ•ˆæœ
                if (powerUp.type === 'speed') {
                    // å¯¹äºå åŠ çš„åŠ é€Ÿæ•ˆæœï¼Œéœ€è¦é€æ­¥æ¢å¤
                    this.speed = powerUp.originalValue;
                } else if (powerUp.type === 'balance') {
                    // æ¢å¤åŸå§‹é˜»å°¼
                } else if (powerUp.type === 'slow') {
                    // å¯¹äºå åŠ çš„å‡é€Ÿæ•ˆæœï¼Œéœ€è¦é€æ­¥æ¢å¤
                    this.speed = powerUp.originalValue;
                } else if (powerUp.type === 'unbalance') {
                    // æ¢å¤åŸå§‹é˜»å°¼
                }
            }
            
            playSound(type) {
                // ç®€å•çš„éŸ³æ•ˆæ¨¡æ‹Ÿï¼ˆä½¿ç”¨Web Audio APIï¼‰
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // æ ¹æ®é“å…·ç±»å‹è®¾ç½®ä¸åŒéŸ³æ•ˆ
                    if (type === 'speed' || type === 'balance') {
                        // æ­£é¢é“å…· - é«˜éŸ³
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    } else if (type === 'explosion') {
                        // æ­»äº¡é“å…· - ä½éŸ³
                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    } else {
                        // è´Ÿé¢é“å…· - ä¸­éŸ³
                        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    }
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    // éŸ³æ•ˆæ’­æ”¾å¤±è´¥æ—¶é™é»˜å¤„ç†
                }
            }
            
            showPowerUpEffect(powerUp) {
                // æ˜¾ç¤ºé“å…·æ•ˆæœæ–‡å­— - åŠ å¤§ä¸¤å€å¹¶æ˜¾ç¤ºåœ¨å±å¹•æ­£ä¸­é—´äººç‰©ä¸‹æ–¹
                const effectText = document.createElement('div');
                effectText.style.position = 'absolute';
                effectText.style.left = '50%';
                effectText.style.top = '60%'; // äººç‰©ä¸‹æ–¹
                effectText.style.transform = 'translateX(-50%)'; // æ°´å¹³å±…ä¸­
                effectText.style.color = this.getPowerUpColor(powerUp.type);
                effectText.style.fontSize = '40px'; // åŠ å¤§ä¸¤å€ï¼ˆä»20pxåˆ°40pxï¼‰
                effectText.style.fontWeight = 'bold';
                effectText.style.pointerEvents = 'none';
                effectText.style.zIndex = '1000';
                effectText.style.textAlign = 'center';
                effectText.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)'; // æ·»åŠ é˜´å½±å¢å¼ºå¯è¯»æ€§
                effectText.textContent = this.getPowerUpText(powerUp.type);
                
                document.body.appendChild(effectText);
                
                // åŠ¨ç”»æ•ˆæœ
                let opacity = 1;
                let y = 60; // ä»60%å¼€å§‹
                const animate = () => {
                    opacity -= 0.015; // ç¨å¾®æ…¢ä¸€ç‚¹çš„æ·¡å‡º
                    y -= 0.5; // å‘ä¸Šç§»åŠ¨
                    effectText.style.opacity = opacity;
                    effectText.style.top = y + '%';
                    
                    if (opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        document.body.removeChild(effectText);
                    }
                };
                animate();
            }
            
            getPowerUpColor(type) {
                const colors = {
                    'speed': '#FF0000',      // çº¢è‰² - å¥½é“å…·
                    'balance': '#FF0000',    // çº¢è‰² - å¥½é“å…·
                    'explosion': '#000000',  // é»‘è‰² - åé“å…·
                    'rock': '#000000',       // é»‘è‰² - åé“å…·
                    'slow': '#000000',       // é»‘è‰² - åé“å…·
                    'unbalance': '#000000'   // é»‘è‰² - åé“å…·
                };
                return colors[type] || '#FFFFFF';
            }
            
            getPowerUpText(type) {
                const texts = {
                    'explosion': 'çˆ†ç‚¸!',
                    'speed': 'é€Ÿåº¦æå‡!',
                    'balance': 'å¹³è¡¡å¢å¼º!',
                    'slow': 'å‡é€Ÿ!',
                    'unbalance': 'å¹³è¡¡ç ´å!'
                };
                return texts[type] || 'æœªçŸ¥é“å…·';
            }
            
            initializeLandscape() {
                // æ¸¸æˆå¼€å§‹æ—¶åˆ›å»ºåˆå§‹ç”°å›­é£æ™¯ï¼Œç¡®ä¿ç”»é¢ä¸­æœ‰å…ƒç´ 
                const leftPositions = [30, 50, 70]; // å·¦ä¾§å›ºå®šä½ç½®ï¼Œé¿å…é‡å 
                const rightPositions = [730, 750, 770]; // å³ä¾§å›ºå®šä½ç½®ï¼Œé¿å…é‡å 
                
                // åˆ›å»ºç”»é¢ä¸­çš„åˆå§‹å…ƒç´ 
                for (let i = 0; i < 3; i++) {
                    const rowY = 100 + i * 150; // ä»ç”»é¢ä¸­å¼€å§‹
                    
                    // å·¦ä¾§å…ƒç´ 
                    const leftX = leftPositions[i];
                    const leftType = ['tree', 'farmhouse'][Math.floor(Math.random() * 2)];
                    this.landscape.push({
                        x: leftX,
                        y: rowY,
                        type: leftType,
                        side: 'left',
                        size: 60 + Math.random() * 120
                    });
                    
                    // å³ä¾§å…ƒç´ 
                    const rightX = rightPositions[i];
                    const rightType = ['tree', 'farmhouse'][Math.floor(Math.random() * 2)];
                    this.landscape.push({
                        x: rightX,
                        y: rowY,
                        type: rightType,
                        side: 'right',
                        size: 60 + Math.random() * 120
                    });
                }
                
                // åˆ›å»ºç”»é¢ä¸Šæ–¹çš„å…ƒç´ 
                for (let i = 0; i < 5; i++) {
                    const rowY = -200 - i * 150; // ä»ä¸Šæ–¹å¼€å§‹ï¼Œé—´éš”æ›´å¤§
                    
                    // å·¦ä¾§å…ƒç´ 
                    const leftX = leftPositions[i % 3];
                    const leftType = ['tree', 'farmhouse'][Math.floor(Math.random() * 2)];
                    this.landscape.push({
                        x: leftX,
                        y: rowY,
                        type: leftType,
                        side: 'left',
                        size: 60 + Math.random() * 120
                    });
                    
                    // å³ä¾§å…ƒç´ 
                    const rightX = rightPositions[i % 3];
                    const rightType = ['tree', 'farmhouse'][Math.floor(Math.random() * 2)];
                    this.landscape.push({
                        x: rightX,
                        y: rowY,
                        type: rightType,
                        side: 'right',
                        size: 60 + Math.random() * 120
                    });
                }
            }
            
            initializeClouds() {
                // æ¸¸æˆå¼€å§‹æ—¶åˆ›å»ºåˆå§‹äº‘æœµ
                for (let i = 0; i < 5; i++) {
                    this.clouds.push({
                        x: Math.random() * this.width,
                        y: 30 + Math.random() * 100,
                        size: 15 + Math.random() * 20,
                        opacity: 0.6 + Math.random() * 0.4
                    });
                }
            }
            
            checkGameOver() {
                if (Math.abs(this.player.sway) >= 60) {
                    this.gameOver();
                }
            }
            
            gameOver() {
                this.gameRunning = false;
                const finalScore = Math.floor(this.distance);
                document.getElementById('finalDistance').textContent = finalScore;
                
                // æ›´æ–°æœ€é«˜åˆ†
                if (finalScore > this.highScore) {
                    this.highScore = finalScore;
                    localStorage.setItem('tightropeHighScore', this.highScore);
                }
                
                document.getElementById('gameOver').style.display = 'block';
            }
            
            updateUI() {
                document.getElementById('distance').textContent = Math.floor(this.distance);
                document.getElementById('sway').textContent = Math.floor(Math.abs(this.player.sway));
                document.getElementById('wind').textContent = (this.wind.force * this.wind.direction).toFixed(2);
                document.getElementById('highScore').textContent = this.highScore;
            }
            
            render() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                this.drawBackground();
                
                // ç»˜åˆ¶é’¢ä¸
                this.drawTightrope();
                
                // ç»˜åˆ¶ç©å®¶
                this.drawPlayer();
                
                // ç»˜åˆ¶é£åŠ›æŒ‡ç¤ºå™¨
                this.drawWindIndicator();
                
                // ç»˜åˆ¶æ‘†å¹…æŒ‡ç¤ºå™¨
                this.drawSwayIndicator();
                
                // ç»˜åˆ¶ç²’å­
                this.drawParticles();
                
                // ç»˜åˆ¶é“å…·
                this.drawPowerUps();
            }
            
            drawBackground() {
                // å¤©ç©ºæ¸å˜
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.5, '#98FB98');
                gradient.addColorStop(1, '#90EE90');
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.width, this.height);
                
                // äº‘æœµï¼ˆæ ¹æ®é£åŠ›ç§»åŠ¨ï¼‰
                this.drawClouds();
                
                // ç”°å›­é£æ™¯ï¼ˆæ»šåŠ¨ï¼‰
                this.drawScrollingLandscape();
                
                // è£…é¥°æ°”çƒå·²åˆ é™¤
            }
            
            drawClouds() {
                this.clouds.forEach(cloud => {
                    this.ctx.save();
                    this.ctx.globalAlpha = cloud.opacity;
                    this.drawCloud(cloud.x, cloud.y, cloud.size);
                    this.ctx.restore();
                });
            }
            
            drawCloud(x, y, size = 20) {
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                this.ctx.beginPath();
                this.ctx.arc(x, y, size, 0, Math.PI * 2);
                this.ctx.arc(x + size * 1.25, y, size * 1.25, 0, Math.PI * 2);
                this.ctx.arc(x + size * 2.5, y, size, 0, Math.PI * 2);
                this.ctx.arc(x + size * 1.25, y - size * 0.75, size, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            drawScrollingLandscape() {
                // ç»˜åˆ¶æ‰€æœ‰æ»šåŠ¨ç”°å›­é£æ™¯å…ƒç´ 
                this.landscape.forEach(element => {
                    this.drawLandscapeElement(element);
                });
            }
            
            drawLandscapeElement(element) {
                const x = element.x;
                const y = element.y;
                const size = element.size;
                
                switch (element.type) {
                    case 'field':
                        // å†œç”°
                        this.ctx.fillStyle = '#90EE90';
                        this.ctx.fillRect(x, y, size, size * 0.6);
                        // å†œç”°çº¹ç†
                        this.ctx.strokeStyle = '#7CCD7C';
                        this.ctx.lineWidth = 1;
                        for (let i = 0; i < 3; i++) {
                            this.ctx.beginPath();
                            this.ctx.moveTo(x, y + i * size * 0.2);
                            this.ctx.lineTo(x + size, y + i * size * 0.2);
                            this.ctx.stroke();
                        }
                        break;
                        
                    case 'tree':
                        // æ ‘æœ¨ï¼ˆæ”¾å¤§3å€ï¼‰
                        this.ctx.fillStyle = '#228B22';
                        this.ctx.beginPath();
                        this.ctx.arc(x + size/2, y + size/3, size/2, 0, Math.PI * 2);
                        this.ctx.fill();
                        // æ ‘å¹²ï¼ˆæ”¾å¤§3å€ï¼‰
                        this.ctx.fillStyle = '#8B4513';
                        this.ctx.fillRect(x + size/2 - 9, y + size/2, 18, size/2);
                        // æ ‘æœ¨ç»†èŠ‚
                        this.ctx.fillStyle = '#32CD32';
                        this.ctx.beginPath();
                        this.ctx.arc(x + size/2 - 15, y + size/3 - 10, size/3, 0, Math.PI * 2);
                        this.ctx.arc(x + size/2 + 15, y + size/3 - 10, size/3, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                        
                    case 'farmhouse':
                        // å†œèˆï¼ˆæ”¾å¤§3å€ï¼‰
                        this.ctx.fillStyle = '#DEB887';
                        this.ctx.fillRect(x, y, size, size * 0.7);
                        // å±‹é¡¶ï¼ˆæ”¾å¤§3å€ï¼‰
                        this.ctx.fillStyle = '#8B4513';
                        this.ctx.beginPath();
                        this.ctx.moveTo(x - 15, y);
                        this.ctx.lineTo(x + size/2, y - 45);
                        this.ctx.lineTo(x + size + 15, y);
                        this.ctx.closePath();
                        this.ctx.fill();
                        // é—¨ï¼ˆæ”¾å¤§3å€ï¼‰
                        this.ctx.fillStyle = '#654321';
                        this.ctx.fillRect(x + size/2 - 12, y + size * 0.4, 24, size * 0.3);
                        // çª—æˆ·ï¼ˆæ”¾å¤§3å€ï¼‰
                        this.ctx.fillStyle = '#87CEEB';
                        this.ctx.fillRect(x + size/4, y + size * 0.2, 12, 12);
                        this.ctx.fillRect(x + size * 3/4 - 12, y + size * 0.2, 12, 12);
                        // çª—æˆ·æ¡†æ¶
                        this.ctx.strokeStyle = '#654321';
                        this.ctx.lineWidth = 2;
                        this.ctx.strokeRect(x + size/4, y + size * 0.2, 12, 12);
                        this.ctx.strokeRect(x + size * 3/4 - 12, y + size * 0.2, 12, 12);
                        break;
                        
                    case 'pond':
                        // æ± å¡˜
                        this.ctx.fillStyle = '#4682B4';
                        this.ctx.beginPath();
                        this.ctx.ellipse(x + size/2, y + size/2, size/2, size/3, 0, 0, Math.PI * 2);
                        this.ctx.fill();
                        // æ°´æ³¢
                        this.ctx.strokeStyle = '#87CEEB';
                        this.ctx.lineWidth = 1;
                        for (let i = 0; i < 2; i++) {
                            this.ctx.beginPath();
                            this.ctx.ellipse(x + size/2, y + size/2 + i * 5, size/2 - 5, size/3 - 3, 0, 0, Math.PI * 2);
                            this.ctx.stroke();
                        }
                        break;
                        
                    case 'crop':
                        // åº„ç¨¼
                        this.ctx.fillStyle = '#9ACD32';
                        for (let i = 0; i < 4; i++) {
                            const cropX = x + i * size/4;
                            this.ctx.fillRect(cropX, y + size * 0.3, 3, size * 0.4);
                        }
                        // åº„ç¨¼é¡¶éƒ¨
                        this.ctx.fillStyle = '#FFD700';
                        for (let i = 0; i < 4; i++) {
                            const cropX = x + i * size/4;
                            this.ctx.beginPath();
                            this.ctx.arc(cropX + 1.5, y + size * 0.2, 2, 0, Math.PI * 2);
                            this.ctx.fill();
                        }
                        break;
                }
            }
            
            drawBuildings() {
                // å·¦ä¾§å»ºç­‘ç¾¤
                this.drawBuilding(50, this.height/2 - 80, 60, 80, '#A0A0A0');
                this.drawBuilding(120, this.height/2 - 60, 50, 60, '#B0B0B0');
                
                // å³ä¾§å»ºç­‘
                this.drawBuilding(this.width - 110, this.height/2 - 100, 70, 100, '#C0C0C0');
                
                // æ·»åŠ çª—æˆ·
                this.drawWindows(50, this.height/2 - 80, 60, 80);
                this.drawWindows(120, this.height/2 - 60, 50, 60);
                this.drawWindows(this.width - 110, this.height/2 - 100, 70, 100);
            }
            
            drawBuilding(x, y, width, height, color) {
                // ç»˜åˆ¶å»ºç­‘ä¸»ä½“ï¼ˆä¿¯ç°è§†è§’ï¼Œæ›´å¤šæ˜¾ç¤ºå±‹é¡¶ï¼‰
                this.ctx.fillStyle = color;
                this.ctx.fillRect(x, y, width, height);
                
                // å»ºç­‘è½®å»“
                this.ctx.strokeStyle = '#666';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(x, y, width, height);
                
                // å±‹é¡¶ï¼ˆä¿¯ç°è§†è§’çš„ä¸‰è§’å½¢å±‹é¡¶ï¼‰
                this.ctx.fillStyle = '#8B4513';
                this.ctx.beginPath();
                this.ctx.moveTo(x - 8, y);
                this.ctx.lineTo(x + width/2, y - 20);
                this.ctx.lineTo(x + width + 8, y);
                this.ctx.closePath();
                this.ctx.fill();
                
                // å±‹é¡¶è½®å»“
                this.ctx.strokeStyle = '#654321';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(x - 8, y);
                this.ctx.lineTo(x + width/2, y - 20);
                this.ctx.lineTo(x + width + 8, y);
                this.ctx.stroke();
                
                // å±‹é¡¶é«˜å…‰
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                this.ctx.beginPath();
                this.ctx.moveTo(x - 6, y - 2);
                this.ctx.lineTo(x + width/2, y - 18);
                this.ctx.lineTo(x + width/2, y - 5);
                this.ctx.closePath();
                this.ctx.fill();
            }
            
            drawWindows(x, y, width, height) {
                // ä¿¯ç°è§†è§’çš„çª—æˆ·ï¼ˆæ›´å°æ›´å¯†é›†ï¼‰
                this.ctx.fillStyle = '#87CEEB';
                const windowSize = 4;
                const spacing = 8;
                
                for (let row = 0; row < Math.floor(height / spacing); row++) {
                    for (let col = 0; col < Math.floor(width / spacing); col++) {
                        const wx = x + 5 + col * spacing;
                        const wy = y + 5 + row * spacing;
                        this.ctx.fillRect(wx, wy, windowSize, windowSize);
                        
                        // çª—æˆ·æ¡†æ¶
                        this.ctx.strokeStyle = '#654321';
                        this.ctx.lineWidth = 1;
                        this.ctx.strokeRect(wx, wy, windowSize, windowSize);
                    }
                }
            }
            
            drawBalloons() {
                // æ°”çƒä½ç½®ï¼ˆè·Ÿéšç©å®¶ç§»åŠ¨ï¼‰
                const balloonX = this.player.x + 80;
                const balloonY = this.height / 2 - 200;
                
                // æ°”çƒçº¿
                this.ctx.strokeStyle = '#8B4513';
                this.ctx.lineWidth = 4;
                this.ctx.beginPath();
                this.ctx.moveTo(balloonX, balloonY);
                this.ctx.lineTo(balloonX, balloonY + 40);
                this.ctx.stroke();
                
                // æ°”çƒ
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4'];
                for (let i = 0; i < 3; i++) {
                    this.ctx.fillStyle = colors[i];
                    this.ctx.beginPath();
                    this.ctx.arc(balloonX + i * 30 - 30, balloonY - 20, 16, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // æ°”çƒé«˜å…‰
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    this.ctx.beginPath();
                    this.ctx.arc(balloonX + i * 30 - 30 - 4, balloonY - 20 - 4, 6, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
            
            drawTightrope() {
                this.ctx.strokeStyle = '#8B4513';
                this.ctx.lineWidth = this.tightrope.thickness;
                this.ctx.beginPath();
                this.ctx.moveTo(this.tightrope.x, 0);
                this.ctx.lineTo(this.tightrope.x, this.height);
                this.ctx.stroke();
            }
            
            drawPlayer() {
                const centerX = this.tightrope.x;
                const centerY = this.height / 2; // è„šçš„ä½ç½®ï¼ˆæ—‹è½¬ä¸­å¿ƒï¼‰
                const sway = this.player.sway;
                
                // ä¿å­˜å½“å‰çŠ¶æ€
                this.ctx.save();
                
                // ç§»åŠ¨åˆ°æ—‹è½¬ä¸­å¿ƒ
                this.ctx.translate(centerX, centerY);
                
                // æ ¹æ®æ‘†å¹…æ—‹è½¬
                this.ctx.rotate(sway * Math.PI / 180);
                
                // ç»˜åˆ¶èº«ä½“ï¼ˆç›¸å¯¹äºæ—‹è½¬ä¸­å¿ƒï¼‰
                this.ctx.fillStyle = '#FF6B6B';
                this.ctx.fillRect(-10, -this.player.size/2, 20, this.player.size);
                
                // ç»˜åˆ¶å¤´éƒ¨
                this.ctx.fillStyle = '#FFE66D';
                this.ctx.beginPath();
                this.ctx.arc(0, -this.player.size/2 - 16, 16, 0, Math.PI * 2);
                this.ctx.fill();
                
                // ç»˜åˆ¶æ‰‹è‡‚ï¼ˆå¹³è¡¡æ†æ•ˆæœï¼‰
                this.ctx.strokeStyle = '#8B4513';
                this.ctx.lineWidth = 6;
                this.ctx.beginPath();
                this.ctx.moveTo(-this.balanceRod.length, 0);
                this.ctx.lineTo(this.balanceRod.length, 0);
                this.ctx.stroke();
                
                // ç»˜åˆ¶çœ¼ç›
                this.ctx.fillStyle = '#000';
                this.ctx.beginPath();
                this.ctx.arc(-6, -this.player.size/2 - 20, 2, 0, Math.PI * 2);
                this.ctx.arc(6, -this.player.size/2 - 20, 2, 0, Math.PI * 2);
                this.ctx.fill();
                
                // ç»˜åˆ¶è„šéƒ¨ï¼ˆä¸é’¢ä¸æ¥è§¦çš„ç‚¹ï¼‰
                this.ctx.fillStyle = '#8B4513';
                this.ctx.beginPath();
                this.ctx.arc(0, this.player.size/2, 6, 0, Math.PI * 2);
                this.ctx.fill();
                
                // æ¢å¤çŠ¶æ€
                this.ctx.restore();
                
                // æ›´æ–°ç©å®¶å®é™…ä½ç½®ï¼ˆç”¨äºæ°”çƒè·Ÿéšç­‰ï¼‰
                this.player.x = centerX;
                this.player.y = centerY;
            }
            
            drawWindIndicator() {
                const x = this.width - 100;
                const y = 50;
                const windForce = this.wind.force * this.wind.direction;
                
                // èƒŒæ™¯
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                this.ctx.fillRect(x - 10, y - 20, 80, 40);
                
                // é£åŠ›æ¡
                this.ctx.fillStyle = windForce > 0 ? '#FF6B6B' : '#4ECDC4';
                const barWidth = Math.abs(windForce) * 60;
                this.ctx.fillRect(x, y - 5, barWidth, 10);
                
                // ä¸­å¿ƒçº¿
                this.ctx.strokeStyle = '#FFF';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.moveTo(x + 30, y - 10);
                this.ctx.lineTo(x + 30, y + 10);
                this.ctx.stroke();
            }
            
            drawSwayIndicator() {
                const x = 50;
                const y = this.height - 100;
                const sway = this.player.sway;
                
                // èƒŒæ™¯åœ†
                this.ctx.strokeStyle = '#FFF';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.arc(x, y, 30, 0, Math.PI * 2);
                this.ctx.stroke();
                
                // å±é™©åŒºåŸŸï¼ˆå·¦å³ä¸¤ä¾§ï¼‰
                this.ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 30, Math.PI * 0.25, Math.PI * 0.75);
                this.ctx.arc(x, y, 30, Math.PI * 1.25, Math.PI * 1.75);
                this.ctx.fill();
                
                // æŒ‡é’ˆï¼ˆæ°´å¹³æ–¹å‘æ˜¾ç¤ºæ‘†å¹…ï¼‰
                this.ctx.strokeStyle = '#FF0';
                this.ctx.lineWidth = 4;
                this.ctx.beginPath();
                this.ctx.moveTo(x, y);
                this.ctx.lineTo(
                    x + Math.sin(sway * Math.PI / 180) * 25,
                    y
                );
                this.ctx.stroke();
            }
            
            drawParticles() {
                this.particles.forEach(particle => {
                    this.ctx.save();
                    this.ctx.globalAlpha = particle.life;
                    this.ctx.fillStyle = '#FFD700';
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.restore();
                });
            }
            
            drawPowerUps() {
                this.powerUps.forEach(powerUp => {
                    this.drawPowerUp(powerUp);
                });
            }
            
            drawPowerUp(powerUp) {
                const x = powerUp.x;
                const y = powerUp.y;
                const size = powerUp.size;
                
                // æ ¹æ®é“å…·ç±»å‹ç¡®å®šæ°”çƒé¢œè‰²
                let balloonColor = '#FFB6C1'; // é»˜è®¤ç²‰è‰²
                let boxColor = '#FFFFFF';
                let textColor = '#000000';
                let text = '';
                
                if (powerUp.type === 'explosion') {
                    balloonColor = '#000000'; // é»‘è‰²æ°”çƒ - åé“å…·
                    text = 'çˆ†ç‚¸';
                } else if (powerUp.type === 'speed') {
                    balloonColor = '#FF0000'; // çº¢è‰²æ°”çƒ - å¥½é“å…·
                    text = 'åŠ é€Ÿ';
                } else if (powerUp.type === 'balance') {
                    balloonColor = '#00FF00'; // ç»¿è‰²æ°”çƒ - å¥½é“å…·
                    text = 'å¹³è¡¡';
                } else if (powerUp.type === 'slow') {
                    balloonColor = '#0080FF'; // è“è‰²æ°”çƒ - åé“å…·
                    text = 'å‡é€Ÿ';
                } else if (powerUp.type === 'unbalance') {
                    balloonColor = '#FFFF00'; // é»„è‰²æ°”çƒ - åé“å…·
                    text = 'å¤±è¡¡';
                }
                
                // ç»˜åˆ¶æ°”çƒï¼ˆæ”¾å¤§3å€ï¼‰
                this.ctx.fillStyle = balloonColor;
                this.ctx.beginPath();
                this.ctx.arc(x, y - 15, 24, 0, Math.PI * 2); // ä»8æ”¾å¤§åˆ°24
                this.ctx.fill();
                
                // æ°”çƒé«˜å…‰
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.beginPath();
                this.ctx.arc(x - 6, y - 19, 6, 0, Math.PI * 2); // é«˜å…‰ä¹Ÿæ”¾å¤§
                this.ctx.fill();
                
                // æ°”çƒçº¿
                this.ctx.strokeStyle = '#8B4513';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(x, y - 7);
                this.ctx.lineTo(x, y + 5);
                this.ctx.stroke();
                
                // ç»˜åˆ¶é“å…·æ–¹å—
                this.ctx.fillStyle = boxColor;
                this.ctx.fillRect(x - size/2, y + 5, size, size);
                this.ctx.strokeStyle = '#000000';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(x - size/2, y + 5, size, size);
                
                // ç»˜åˆ¶é“å…·æ–‡å­—
                this.ctx.fillStyle = textColor;
                this.ctx.font = 'bold 12px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(text, x, y + 18);
            }
            
            gameLoop() {
                this.update();
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', () => {
            new TightropeGame();
        });
    </script>
</body>
</html>
